from openai import AzureOpenAI
import re

# Initialize Azure OpenAI client
client = AzureOpenAI(
    api_key="YOUR_AZURE_OPENAI_KEY",
    api_version="2023-05-15",
    azure_endpoint="YOUR_AZURE_ENDPOINT"
)

def get_detection_prompt(text):
    return f"""
    **Task**: Classify if the following text is offensive (False) or normal (True).  
    **Languages Supported**: English, Spanish, French, German, Hindi, etc.  

    **Offensive Language Includes**:  
    - Profanity, slurs, hate speech.  
    - Threats, harassment, or sexually explicit content.  
    - Severe toxicity (e.g., racism, sexism).  

    **Normal Language**:  
    - Polite, neutral, or professional discourse.  
    - No harmful intent.  

    **Examples**:  
    - Normal: "Hello, how are you?" → True  
    - Offensive: "You idiot!" → False  

    **Text to Analyze**:  
    "{text}"  

    **Output Format**:  
    - Return ONLY "True" (normal) or "False" (offensive).  
    """

def detect_offensive_language(text):
    try:
        response = client.chat.completions.create(
            model="gpt-4",  # or your Azure OpenAI model name
            messages=[
                {"role": "system", "content": "You are a multilingual content moderation AI."},
                {"role": "user", "content": get_detection_prompt(text)}
            ],
            temperature=0.0  # Strict classification
        )
        result = response.choices[0].message.content.strip()
        return result == "True"
    except Exception as e:
        print(f"Error: {e}")
        return True  # Fail-safe: Assume non-offensive if error occurs

def format_output(text, language_code="en"):
    is_normal = detect_offensive_language(text)
    offence_msg = "Inappropriate language" if not is_normal else ""
    return f"{text}|{language_code}|{'T' if is_normal else 'F'}|{offence_msg}"


# Test Cases
test_cases = [
    ("Hello, how are you?", "en"),      # Normal (T)
    ("You’re a worthless idiot!", "en"), # Offensive (F)
    ("Das ist scheiße!", "de"),         # Offensive (F)
    ("Bonjour, merci!", "fr"),         # Normal (T)
    ("¡Eres estúpido!", "es")           # Offensive (F)
]

for text, lang in test_cases:
    print(format_output(text, lang))
